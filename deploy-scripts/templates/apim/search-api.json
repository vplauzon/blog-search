{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "apimName": {
            "type": "string",
            "minLength": 2,
            "metadata": {
                "description": "API-M's Name"
            }
        },
        "apimId": {
            "type": "string",
            "minLength": 2,
            "metadata": {
                "description": "API-M's resource ID"
            }
        },
        "searchKey": {
            "type": "string",
            "minLength": 2,
            "metadata": {
                "description": "Search Query Key"
            }
        }
    },
    "variables": {
    },
    "resources": [
        {
            "type": "Microsoft.ApiManagement/service/apis",
            "apiVersion": "2019-01-01",
            "name": "[concat(parameters('apimName'), '/search')]",
            "dependsOn": [
                "[parameters('apimId')]"
            ],
            "properties": {
                "displayName": "search",
                "apiRevision": "1",
                "path": "search",
                "protocols": [
                    "https"
                ],
                "isCurrent": true
            },
            "resources": [
                {
                    "type": "policies",
                    "apiVersion": "2019-01-01",
                    "name": "policy",
                    "dependsOn": [
                        "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimName'), 'search')]"
                    ],
                    "properties": {
                        "value": "<!--\r\n    IMPORTANT:\r\n    - Policy elements can appear only within the <inbound>, <outbound>, <backend> section elements.\r\n    - To apply a policy to the incoming request (before it is forwarded to the backend service), place a corresponding policy element within the <inbound> section element.\r\n    - To apply a policy to the outgoing response (before it is sent back to the caller), place a corresponding policy element within the <outbound> section element.\r\n    - To add a policy, place the cursor at the desired insertion point and select a policy from the sidebar.\r\n    - To remove a policy, delete the corresponding policy statement from the policy document.\r\n    - Position the <base> element within a section element to inherit all policies from the corresponding section element in the enclosing scope.\r\n    - Remove the <base> element to prevent inheriting policies from the corresponding section element in the enclosing scope.\r\n    - Policies are applied in the order of their appearance, from the top down.\r\n    - Comments within policy elements are not supported and may disappear. Place your comments between policy elements or at a higher level scope.\r\n-->\r\n<policies>\r\n  <inbound>\r\n    <base />\r\n    <cors allow-credentials=\"true\">\r\n      <allowed-origins>\r\n        <origin>http://localhost:53147/</origin>\r\n        <origin>https://vplauzon.github.io/</origin>\r\n      </allowed-origins>\r\n      <allowed-methods preflight-result-max-age=\"300\">\r\n        <method>GET</method>\r\n        <method>OPTIONS</method>\r\n      </allowed-methods>\r\n      <allowed-headers>\r\n        <header>*</header>\r\n      </allowed-headers>\r\n      <expose-headers>\r\n        <header>*</header>\r\n      </expose-headers>\r\n    </cors>\r\n  </inbound>\r\n  <backend>\r\n    <base />\r\n  </backend>\r\n  <outbound>\r\n    <base />\r\n  </outbound>\r\n  <on-error>\r\n    <base />\r\n  </on-error>\r\n</policies>",
                        "format": "xml"
                    }
                },
                {
                    "type": "operations",
                    "apiVersion": "2019-01-01",
                    "name": "get",
                    "dependsOn": [
                        "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimName'), 'search')]"
                    ],
                    "properties": {
                        "displayName": "get",
                        "method": "GET",
                        "urlTemplate": "/",
                        "templateParameters": [
                        ],
                        "request": {
                            "queryParameters": [
                                {
                                    "name": "query",
                                    "description": "Text to look for",
                                    "values": [
                                    ],
                                    "type": "string"
                                },
                                {
                                    "name": "top",
                                    "values": [
                                    ],
                                    "type": "string"
                                }
                            ],
                            "headers": [
                            ],
                            "representations": [
                            ]
                        },
                        "responses": [
                        ]
                    },
                    "resources": [
                        {
                            "type": "policies",
                            "apiVersion": "2019-01-01",
                            "name": "policy",
                            "dependsOn": [
                                "[resourceId('Microsoft.ApiManagement/service/apis/operations', parameters('apimName'), 'search', 'get')]"
                            ],
                            "properties": {
                                "value": "<policies>\r\n  <inbound>\r\n    <base />\r\n    <!--    Limit number of calls per seconds    -->\r\n    <rate-limit calls=\"2\" renewal-period=\"2\" />\r\n    <!--    Remove subscription key from the backend call    -->\r\n    <set-header id=\"remove-sub-key\" name=\"Ocp-Apim-Subscription-Key\" exists-action=\"delete\" />\r\n    <!--    Remove query string    -->\r\n    <set-query-parameter name=\"query\" exists-action=\"delete\" />\r\n    <!--    Force content type to be JSON    -->\r\n    <set-header id=\"set-content-type\" name=\"Content-Type\" exists-action=\"override\">\r\n      <value>application/json</value>\r\n    </set-header>\r\n    <!--    Force Accept to be JSON    -->\r\n    <set-header id=\"set-accept\" name=\"Accept\" exists-action=\"override\">\r\n      <value>application/json</value>\r\n    </set-header>\r\n    <!--    Set API-Key to Search API    -->\r\n    <set-header id=\"set-api-key\" name=\"api-key\" exists-action=\"override\">\r\n      <value>E62E92BC573698030A3B9910EE2A24E4</value>\r\n    </set-header>\r\n    <!--    Set method to POST    -->\r\n    <set-method id=\"go-to-post\">POST</set-method>\r\n    <!--    Set body to the actual query    -->\r\n    <set-variable name=\"body\" value=\"@{&#xA;            var isTop = bool.Parse(context.Request.OriginalUrl.Query.GetValueOrDefault(&quot;top&quot;));&#xA;            var body = new&#xA;            {&#xA;                count=true,&#xA;                facets=new object[0],&#xA;                queryType=&quot;simple&quot;,&#xA;                scoringParameters=new object[0],&#xA;                search=context.Request.OriginalUrl.Query.GetValueOrDefault(&quot;query&quot;),&#xA;                searchMode=&quot;any&quot;,&#xA;                select=&quot;Excerpt,Title,Url,Published,Tags&quot;,&#xA;                top=isTop ? 3 : 27,&#xA;                skip=isTop ? (int?)null : 3&#xA;            };&#xA;            var obj = JObject.FromObject(body);&#xA;            var text = obj.ToString();&#xA;&#xA;            return text;&#xA;        }\" />\r\n    <set-body>@((string)context.Variables[\"body\"])</set-body>\r\n    <!--    Back-end URL    -->\r\n    <set-backend-service base-url=\"https://vplmvp.search.windows.net/indexes('index-a')/docs/search.post.search\" />\r\n    <!--    Remove /top from URL    -->\r\n    <rewrite-uri template=\"/\" copy-unmatched-params=\"false\" />\r\n    <!--    Add API version query string    -->\r\n    <set-query-parameter name=\"api-version\" exists-action=\"override\">\r\n      <value>2019-05-06</value>\r\n    </set-query-parameter>\r\n  </inbound>\r\n  <backend>\r\n    <base />\r\n  </backend>\r\n  <outbound>\r\n    <base />\r\n  </outbound>\r\n  <on-error>\r\n    <base />\r\n  </on-error>\r\n</policies>",
                                "format": "xml"
                            }
                        }
                    ]
                }
            ]
        },
        {
            "type": "Microsoft.ApiManagement/service/properties",
            "apiVersion": "2019-01-01",
            "name": "[concat(parameters('apimName'), '/api-search-search-query-key')]",
            "dependsOn": [
                "[parameters('apimId')]"
            ],
            "properties": {
                "displayName": "api-search-search-query-key",
                "value": "[parameters('searchKey')]",
                "secret": true
            }
        }
    ],
    "outputs": {
    }
}